# Car_distance_prediction
## Условие задачи
Перед участниками чемпионата стоит задача — разработать алгоритм,
позволяющий определить дистанцию до впереди идущего автомобиля,
используя для этого датасет фотографий автомобилей с разного расстояния.
Впоследствии этот алгоритм может быть использован в системах навигации
для предупреждения об опасном сближении и для контроля за
соблюдением дистанции.
## Описание входных значений
train – набор изображений с автомобилями
train.csv – для каждого изображения из train по названию файла определено
расстояние для автомобиля
test – набор изображений, для которых необходимо определить целевое
значениеМетрика
## Коэффициент детерминации (R2):
$$ R2 = 1 - \frac{\sum\limits_{i=1}^n (y_i-\hat{y})^2}{\sum\limits_{i=1}^n (y_i-\bar{y})^2} $$

## Сбор признаков из изображений
Для решения задачи было подготовлено 3 модуля для извлечения признаков из изображений:

> Модель детекции автомобилей;

> Модель детекции номерных знаков автомобилей;

> Модель для преобразования изображения в карту глубины;

1. В качестве модели для детекции автомобилей использовась одна из предобученных 
на датасете COCO нейросетей из библиотеки [detectron2](https://github.com/facebookresearch/detectron2).
2. Для детекции номерных знаков была специально обучена [maskrcnn_resnet50_fpn](https://pytorch.org/vision/main/models/generated/torchvision.models.detection.maskrcnn_resnet50_fpn.html#torchvision.models.detection.maskrcnn_resnet50_fpn). 
Пайплайн обучения этой модели находится в файле Carplates_detector.ipynb.
3. Для получения относительной глубины из изображения была использована предобученная нейросеть 
[MiDaS](https://pytorch.org/hub/intelisl_midas_v2/). Далее из полученных карт глубины извлекалась информация 
о расстоянии до автомобилей. Метод получения относительного расстояния до машин схож с описанным в [статье](https://arxiv.org/pdf/2111.01715.pdf).

## Получение предсказаний и результат
На финальном этапе признаки, извлечённые всеми трёмя модулями были объединены в один pandas dataframe.
Столбцы датафейма включали координаты bounding box автомобиля (x_min_car, x_max_car, y_min_car, y_max_car),
уверенность модели в детекции автомобиля (confidence), bounding box номерного знака (x_min, x_max, y_min, y_max),
уверенность модели в детекции номерного знака (carplate_conf), медианное значение пикселей карты глубины внутри
bounding box автомобиля (median_depth_value), а также синтетические признаки: размеры номерного знака (width, height),
ширина автомобиля (car_width).
Полученный датафрейм вместе со значениями целевой переменной был подан на вход CatBoost регрессора.
> С помощью описанного метода на лидерборде был получен результат 0.939446 по метрике R2.
